<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <title>„ÅÇ„Åã„Çä„Å°„ÇÉ„Çì</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuOBguOBi+OCiuOBoeOCg+OCkyIsCiAgInNob3J0X25hbWUiOiAi44GC44GL44KK44GhIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJ0aGVtZV9jb2xvciI6ICIjNEY0NkU1IiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRkZGRkZGIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJaU5EWkVRVVl5T1NJZ2VHMXNibk05SW1oMGRIQTZMeTkzZDNjdWR6TXViM0puTHpJd01EQXZjM1puSWo0OGNtVmpkQ0IzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdabWxzYkQwaVl6QTBVVFJCUVVZaUx6NDhjM1JsY0dGMGFDQmtQU0pOU2pZMElERXlORU14TWpnZ05qUkRNVEk0SURJNUxqTXhNalU1SURFd09TNFFOVEV5TlNBeU9DQXpNRUl5TnprZ09Ta3haREkwSWlCMWNuUWdQU0lpUW1ac05DSXZQanh3WVhSb0lHUTlJazB4TmpRZ05UZERNVGszTGpNeE16VWdOVFFnTVRJNElEVTBZelE1TGpjMk5UZ2dNQ0E1TUNBd0lEa3dJRGd6TG1ScGRtZ2dOek1nZEc5allqa2djemxzUVZOc0lqNUJlaXhHTkZGT1pGVWdVWE5xYWt0a2FscHVlbGRxWldSWFlnPT0iLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
        }
        
        .message-animation {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .pulse-dot {
            animation: pulseDot 1.4s infinite ease-in-out;
        }
        
        .pulse-dot:nth-child(1) { animation-delay: -0.32s; }
        .pulse-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes pulseDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* PWAÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        @media (display-mode: standalone) {
            body {
                -webkit-user-select: none;
                user-select: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Ë®≠ÂÆöÔºà„Åì„Åì„ÇíÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
        const CONFIG = {
            CLAUDE_API_KEY: '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',
            CLAUDE_MODEL: 'claude-3-sonnet-20240229',
            MAX_TOKENS: 1000
        };

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Éò„É´„Éë„Éº
        const storage = {
            getMessages: () => {
                try {
                    return JSON.parse(localStorage.getItem('akari_messages') || '[]');
                } catch {
                    return [];
                }
            },
            saveMessages: (messages) => {
                localStorage.setItem('akari_messages', JSON.stringify(messages));
            },
            getLastVisit: () => {
                return localStorage.getItem('akari_last_visit');
            },
            setLastVisit: () => {
                localStorage.setItem('akari_last_visit', new Date().toISOString());
            },
            getUserProfile: () => {
                try {
                    return JSON.parse(localStorage.getItem('akari_user_profile') || '{}');
                } catch {
                    return {};
                }
            },
            saveUserProfile: (profile) => {
                localStorage.setItem('akari_user_profile', JSON.stringify(profile));
            }
        };

        // ÊôÇÈñì„Å´Âü∫„Å•„Åè„Ç∞„É™„Éº„ÉÜ„Ç£„É≥„Ç∞
        const getGreeting = () => {
            const hour = new Date().getHours();
            const lastVisit = storage.getLastVisit();
            const timeSinceLastVisit = lastVisit ? Date.now() - new Date(lastVisit).getTime() : 0;
            const isReturning = timeSinceLastVisit > 3600000; // 1ÊôÇÈñì‰ª•‰∏ä

            if (isReturning) {
                if (hour >= 18 || hour < 6) {
                    return "„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ‰ªäÊó•„ÇÇ„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„Åü„ÄÇ„Å©„Çì„Å™‰∏ÄÊó•„Åß„Åó„Åü„ÅãÔºü";
                } else if (hour < 12) {
                    return "„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ‰ªäÊó•„ÇÇ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ";
                } else {
                    return "„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åô„ÄÇ";
                }
            }

            if (hour < 6) return "Â§úÊõ¥„Åã„Åó„Åß„Åô„Å≠„ÄÇ‰Ωï„ÅãÊ∞ó„Å´„Å™„Çã„Åì„Å®„Åß„ÇÇ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü";
            if (hour < 12) return "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ‰ªäÊó•„ÅØ„Å©„Çì„Å™„Åì„Å®„ÇíË©±„Åó„Åæ„Åó„Çá„ÅÜ„ÅãÔºü";
            if (hour < 18) return "„Åì„Çì„Å´„Å°„ÅØÔºÅË™øÂ≠ê„ÅØ„ÅÑ„Åã„Åå„Åß„Åô„ÅãÔºü";
            return "„Åì„Çì„Å∞„Çì„ÅØÔºÅ‰ªäÊó•„ÅØ„Å©„Çì„Å™‰∏ÄÊó•„Åß„Åó„Åü„ÅãÔºü";
        };

        // Claude APIÂëº„Å≥Âá∫„Åó
        const callClaudeAPI = async (messages) => {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CONFIG.CLAUDE_API_KEY,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: CONFIG.CLAUDE_MODEL,
                        max_tokens: CONFIG.MAX_TOKENS,
                        messages: messages.map(msg => ({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: msg.text
                        }))
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('Claude API Error:', error);
                throw error;
            }
        };

        // Ë®≠ÂÆö„Éë„Éç„É´„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        function SettingsPanel({ isOpen, onClose, apiKey, setApiKey }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md">
                        <h2 className="text-lg font-semibold text-gray-800 mb-4">Ë®≠ÂÆö</h2>
                        
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Claude API„Ç≠„Éº
                            </label>
                            <input
                                type="password"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder="sk-ant-api03-..."
                                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <p className="text-xs text-gray-500 mt-1">
                                Anthropic Console „ÅßÂèñÂæó„Åß„Åç„Åæ„Åô
                            </p>
                        </div>

                        <div className="flex space-x-3">
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-100 text-gray-800 rounded-lg py-2 font-medium"
                            >
                                Èñâ„Åò„Çã
                            </button>
                            <button
                                onClick={() => {
                                    localStorage.setItem('akari_api_key', apiKey);
                                    CONFIG.CLAUDE_API_KEY = apiKey;
                                    onClose();
                                }}
                                className="flex-1 bg-blue-500 text-white rounded-lg py-2 font-medium"
                            >
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AkariChat() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [error, setError] = useState('');
            const messagesEndRef = useRef(null);

            useEffect(() => {
                // API„Ç≠„Éº„ÅÆÂàùÊúüÂåñ
                const savedApiKey = localStorage.getItem('akari_api_key');
                if (savedApiKey) {
                    setApiKey(savedApiKey);
                    CONFIG.CLAUDE_API_KEY = savedApiKey;
                }

                // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂàùÊúüÂåñ
                const savedMessages = storage.getMessages();
                const greeting = getGreeting();
                
                if (savedMessages.length === 0) {
                    setMessages([{
                        id: 1,
                        text: greeting,
                        sender: 'akari',
                        timestamp: new Date()
                    }]);
                } else {
                    setMessages(savedMessages);
                    
                    // Â∏∞ÂÆÖÊôÇ„ÅÆ„Ç∞„É™„Éº„ÉÜ„Ç£„É≥„Ç∞
                    const lastMessage = savedMessages[savedMessages.length - 1];
                    const timeSinceLastMessage = Date.now() - new Date(lastMessage.timestamp).getTime();
                    
                    if (timeSinceLastMessage > 3600000) { // 1ÊôÇÈñì‰ª•‰∏ä
                        setTimeout(() => {
                            const welcomeBack = {
                                id: Date.now(),
                                text: greeting,
                                sender: 'akari',
                                timestamp: new Date()
                            };
                            setMessages(prev => [...prev, welcomeBack]);
                        }, 1000);
                    }
                }
                
                storage.setLastVisit();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            useEffect(() => {
                if (messages.length > 0) {
                    storage.saveMessages(messages);
                }
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim()) return;
                
                setError('');

                // API„Ç≠„Éº„ÉÅ„Çß„ÉÉ„ÇØ
                if (!CONFIG.CLAUDE_API_KEY || CONFIG.CLAUDE_API_KEY.startsWith('sk-ant-api03-„ÅÇ„Å™„Åü„ÅÆ')) {
                    setError('API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆö„Åã„ÇâÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                const userMessage = {
                    id: Date.now(),
                    text: input,
                    sender: 'user',
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsTyping(true);

                try {
                    const response = await callClaudeAPI([...messages, userMessage]);
                    
                    const akariMessage = {
                        id: Date.now() + 1,
                        text: response,
                        sender: 'akari',
                        timestamp: new Date()
                    };

                    setMessages(prev => [...prev, akariMessage]);
                } catch (error) {
                    console.error('Error:', error);
                    const errorMessage = {
                        id: Date.now() + 1,
                        text: "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ„ÄÅ„ÅÜ„Åæ„ÅèÂøúÁ≠î„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                        sender: 'akari',
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                    setError('APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                } finally {
                    setIsTyping(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const clearChat = () => {
                if (confirm('‰ºöË©±Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    setMessages([{
                        id: Date.now(),
                        text: "Êñ∞„Åó„ÅÑ‰ºöË©±„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ‰Ωï„ÇíË©±„Åó„Åæ„Åô„ÅãÔºü",
                        sender: 'akari',
                        timestamp: new Date()
                    }]);
                    localStorage.removeItem('akari_messages');
                }
            };

            return (
                <div className="flex flex-col h-screen bg-gradient-to-br from-purple-50 to-blue-50">
                    {/* „Éò„ÉÉ„ÉÄ„Éº */}
                    <div className="bg-white shadow-sm border-b border-gray-200 p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <div className="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    „ÅÇ
                                </div>
                                <div className="ml-3">
                                    <h1 className="text-lg font-semibold text-gray-800">„ÅÇ„Åã„Çä„Å°„ÇÉ„Çì</h1>
                                    <p className="text-sm text-gray-500">„ÅÑ„Å§„Åß„ÇÇË©±„ÇíËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô</p>
                                </div>
                            </div>
                            <div className="flex space-x-2">
                                <button
                                    onClick={clearChat}
                                    className="p-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100"
                                    title="‰ºöË©±„Çí„ÇØ„É™„Ç¢"
                                >
                                    üóëÔ∏è
                                </button>
                                <button
                                    onClick={() => setShowSettings(true)}
                                    className="p-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100"
                                    title="Ë®≠ÂÆö"
                                >
                                    ‚öôÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        {error && (
                            <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <p className="text-sm text-red-600">{error}</p>
                            </div>
                        )}
                    </div>

                    {/* „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((message) => (
                            <div
                                key={message.id}
                                className={`message-animation flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                            >
                                <div
                                    className={`max-w-xs md:max-w-md px-4 py-3 rounded-2xl ${
                                        message.sender === 'user'
                                            ? 'bg-blue-500 text-white'
                                            : 'bg-white text-gray-800 shadow-sm border border-gray-200'
                                    }`}
                                >
                                    <p className="text-sm leading-relaxed whitespace-pre-wrap">{message.text}</p>
                                    <p className={`text-xs mt-2 ${
                                        message.sender === 'user' ? 'text-blue-100' : 'text-gray-400'
                                    }`}>
                                        {new Date(message.timestamp).toLocaleTimeString('ja-JP', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </p>
                                </div>
                            </div>
                        ))}
                        
                        {isTyping && (
                            <div className="flex justify-start">
                                <div className="bg-white text-gray-800 shadow-sm border border-gray-200 px-4 py-3 rounded-2xl">
                                    <div className="flex space-x-1">
                                        <div className="w-2 h-2 bg-gray-400 rounded-full pulse-dot"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full pulse-dot"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full pulse-dot"></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div ref={messagesEndRef} />
                    </div>

                    {/* ÂÖ•Âäõ„Ç®„É™„Ç¢ */}
                    <div className="bg-white border-t border-gray-200 p-4">
                        <div className="flex space-x-3">
                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="„Å™„Çì„Åß„ÇÇË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Å≠..."
                                className="flex-1 resize-none border border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                rows="1"
                                style={{ minHeight: '48px', maxHeight: '120px' }}
                            />
                            <button
                                onClick={sendMessage}
                                disabled={!input.trim() || isTyping}
                                className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-2xl px-6 py-3 font-medium transition-colors duration-200 disabled:cursor-not-allowed"
                            >
                                ÈÄÅ‰ø°
                            </button>
                        </div>
                    </div>

                    {/* Ë®≠ÂÆö„Éë„Éç„É´ */}
                    <SettingsPanel
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        apiKey={apiKey}
                        setApiKey={setApiKey}
                    />
                </div>
            );
        }

        // PWA Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'akari-v1';
                const urlsToCache = [
                    '/',
                    'https://unpkg.com/react@18/umd/react.development.js',
                    'https://unpkg.com/react-dom@18/umd/react-dom.development.js',
                    'https://unpkg.com/@babel/standalone/babel.min.js',
                    'https://cdn.tailwindcss.com'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('PWA Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('PWA Service Worker registration failed:', error);
                });
        }

        // „Ç¢„Éó„É™„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        ReactDOM.render(<AkariChat />, document.getElementById('root'));
    </script>
</body>
</html>
